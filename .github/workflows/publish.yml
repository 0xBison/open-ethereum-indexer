name: Publish Package

on:
  release:
    types: [created]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.4'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      # - name: Run tests
      #   run: pnpm test

      # - name: Run E2E tests
      #   run: pnpm test:e2e:indexer

      # Configure Git
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # Use release tag version instead of auto-bumping
      - name: Set version from release tag
        run: |
          echo "ğŸ“¦ Setting version from release tag..."
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "ğŸ·ï¸ Release tag version: $VERSION"

          # Update root package.json
          pnpm version $VERSION --no-git-tag-version --allow-same-version

          # Update indexer package version
          pnpm version --filter @open-ethereum/indexer $VERSION --no-git-tag-version --allow-same-version
          echo "âœ… Updated package.json versions to $VERSION"

      - name: Publish indexer package
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
        run: |
          echo "ğŸ“¤ Publishing package to npm..."
          pnpm publish --filter @open-ethereum/indexer --no-git-checks --access public
          echo "âœ… Successfully published to npm!"

      # Commit the version change after successful publish
      - name: Commit version change
        run: |
          echo "ğŸ’¾ Committing version change to repository..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add package.json packages/indexer/package.json
          echo "ğŸ“ Current changes to be committed:"
          git diff --cached
          git commit -m "chore: update package version to match release [skip ci]"
          git push origin HEAD:main
          echo "âœ… Successfully pushed version change to main branch"
